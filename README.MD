# Шаблон для начала проекта на Symfony
[![PHP 8.1](https://img.shields.io/badge/php-8.1-%23777BB4?style=for-the-badge&logo=php&logoColor=black">)](https://www.php.net/releases/8_1_0.php)
[![MariaDB 10.3](https://img.shields.io/badge/MariaDB-10.3-003545?style=for-the-badge&logo=mariadb&logoColor=white)](https://mariadb.com/kb/en/mariadb-10332-release-notes/)
[![Nginx 1.17](https://img.shields.io/badge/nginx-1.17-%23009639.svg?style=for-the-badge&logo=nginx&logoColor=white)](https://nginx.org/en/CHANGES-1.18)
[![Symfony 6.1](https://img.shields.io/badge/symfony-6.1-%23000000.svg?style=for-the-badge&logo=symfony&logoColor=white)](https://symfony.com/doc/6.1)
[![Yarn](https://img.shields.io/badge/yarn-%232C8EBB.svg?style=for-the-badge&logo=yarn&logoColor=white)](https://www.npmjs.com/package/yarn/v/1.22.5)

  * [Основная структура директорий](#основная-структура-директорий)
  * [С чего начать :heavy_check_mark:](#с-чего-начать-heavy_check_mark)
    * [Верстка с фронта](#верстка-с-фронта)
    * [Переменные проекта](#переменные-проекта)
  * [Makefile](#makefile)
  * [Развернуть локально в Docker :heavy_check_mark:](#развернуть-локально-в-docker-heavy_check_mark)
  * [Развернуть на сервере прод/стейджинг](#Развернуть-на-сервере-прод/стейджинг)
    * [Первичная конфигурация: делаем один раз](#первичная-конфигурация-делаем-один-раз)
    * [Дальнейшие правки: по необходимости](#дальнейшие-правки-по-необходимости)
  * [Что-то пошло не так :wrench:](#чтото-пошло-не-так-wrench)
    * [Локально](#локально)
    * [На сервере](#на-сервере)
  * [~~Деплой на сервер с помощью CAPISTRANO~~](#деплой-на-сервер-с-помощью-capistrano)

Что тут есть:
+ локальная работа с проектом через docker-compose
+ schickling/mailcatcher для перехвата писем при работе в dev локально

## Основная структура директорий
- /docker - в этой директории лежит, всё что нужно для поднятия проекта в Docker-контейнерах
- /volumes - работа с вольюмами докер-контейнеров:
  - подключить дополнительные папки к контейнеру, например для эмуляции стороннего storage
  - подключить данные из контейнера
- /project - собственно здесь и находится сам проект, корневая директория Symfony 6.
  - Содержимое этой директории монтируется (как volume) в директорию /project в контейнерах php-cli и php-fpm
  - Если на проекте используется отдельный фреймворк для фронта, есть два варианта:
    - а) хранить его на отдельном репозитории и поднимать отдельно
    - б) то его нужно положить в директорию рядом с /project и содержимое её отдельно монтировать в контейнер nginx

> ПОСЛЕ ТОГО, КАК ВЫ ЗАБРАЛИ ЭТОТ ШАБЛОН,
> НЕОБХОДИМО ИЗМЕНИТЬ РЕПОЗИТОРИЙ НА РАЗРАБАТЫВАЕМЫЙ ПРОЕКТ, ДАБЫ НЕ ПУШИТЬ В ШАБЛОН!

## С чего начать :heavy_check_mark:

1) [ ] в /project/.env указать переменную APP_NAME с названием проекта
2) [ ] в папке docker-compose указать свободные порты для контейнеров nginx, db и mailer (перехватчик писем)
3) [ ] в  /project/.env.local.tmpl указать настройки, актуальные для сервера (прод или стейджинг). 
   - Файл .env.local.tmpl это шаблон на основании, которого создается файл .env.local
   - Файл .env.local переопределяет параметры, указанные в .env
   - Файл .env.local исключен из гита, а файл .env.local.tmpl - нет. Поэтому .env.local.tmpl используются для хранения переопределений в гите.
   - Чтобы значения в .env.local.tmpl вступили в силу при разворачивании проекта файл .env.local.tmpl нужно скопировать под новым названием .env.local
4) ~~в папке dev-tools, настроить capistrano  (в файлах есть описание)~~

### Верстка с фронта
1. Если не используется фреймворк для фронта:
   - Для удобства дальнейшей разработки содержимое папки front, если оно есть, надо перенести в app, а саму папку front - удалить. \
      Чтобы получить html-файлы можно собрать фронт вебпаком прямо в этой папке. Папка /assets/dist и /assets/node_modules добавлены в гитигнор.
2. Если на фронте React.js/Next.js, Vue.js/Nuxt.js, Angular или другой фреймворк:
    - а) Положить его в директорию рядом с /project. Содержимое этой директории монтировать отдельно в контейнер nginx
    - б) хранить его на отдельном репозитории и поднимать отдельно

### Переменные проекта
Переменные проекта заданы в файле /project/.env . Это основной файл, который должен содержать все переменные, даже если 
какая-то переменная нужна только на тесте, она всё равно должна быть указана в .env
Так как /project/.env находится в git - это лучшее место для хранения *универсальных* настроек нужных для разработки

Файл .env.local нужен для хранения локальных изменений, специфичных для окружения. Идеально подходит для:
- Определения настроек для разворачивания проекта на сервере, как стейджинг, так и прод. Для этого вручную создается 
в папке /project на сервере (можно создать на основе .env.local.tmpl)
- Определения локальных или временных настроек необходимых для разработки проекта, без необходимости передавать эти 
параметры в git 

> Файлы локальных переменных .env.local добавлены в гитигнор, так и должно быть. Symfony использует эти файлы для настройки
> локальных переменных при работе локально через докер или при выгрузке на прод или стейджинг сервер. Переменные в этих файлах
> на проде, стейджинге и при локальной разработке, как правило, отличаются.  

## Makefile
Все необходимые команды прописаны в Makefile (нужно в него зайти и посмотреть)
Например:
Запуск webpack в dev режиме
`make yarn-watch`

## Развернуть локально в Docker :heavy_check_mark:
Развернуть на локальной машине:
1) [ ] В корневой папке запустить "make init"
2) [ ] запустить миграции (``make app-migrations``)
3) [ ] накатить фикстуры (``make app-php-cli-bash`` -> ``symfony console d:f:l``)
    - login : admin@positron-it.ru
    - pass : symD3V \
    ФИКСТУРЫ НА ПРОДЕ НЕ РАБОТАЮТ!

Сайт доступен на http://localhost:<указать порт!> \

## Развернуть на сервере прод/стейджинг

### Первичная конфигурация: делаем один раз

Для поднятия проекта на сервере в Makefile прописаны команды, которые делают то, что в нормальном продакшене
делает CI/CD. Для их корректной работы нужны указать версию PHP в переменной PROD_PHP (прямо в Makefile). \
vendor и ассеты фронта исключены с гита и собираются с помощью команд CLI. При первом разворачивании проекта на 
сервере нужно выполнить следующую последовательность операций:

1) `git clone https://gitlab.grokhotov.ru/positron-it/<название_проекта>.git` в папке на сервере
   - если для staging- или prod- версии используется отдельная ветка, переключится в ветку с нужной версией проекта (test, release)
2) `git pull`
3) прописать переменные характерные для серверного окружения в .env.local
4) в файле Makefile указать в переменной PROD_PHP путь до нужной версии PHP на сервере
5) Установить пакеты композера, установить миграции, и собрать ассеты. Всё это лучше делать с помощью команд в Makefile
   - пакеты композера ставить командой `install`, а не `update`. При этом composer.lock должен быть получен из git'а

### Дальнейшие правки: по необходимости
Так как CI/CD - нет, после обновления кодовой базы проекта на сервере из репозитория (`git pull`), нужно обновлять и файлы, которые исключены из репозитория:
- пакеты композера
- кэш приложения
- ассеты
- а также структуру БД

Для это есть команда `make prod-build` которая выполняет все эти действия, но работает долго, так что это не всегда 
лучшее решение - не всегда нужен сброс кэша приложения, а без кэша сайт по началу работает медленно. \
Команда `make prod-build` объединяет следующие команды, которые можно запустить по отдельности:
- установить новые пакеты композера ```prod-composer-install``` - устанавливает из composer.lock, поэтому 
и не только поэтому этот файл должен быть в гите.
- затянуть изменения БД из миграций ```make prod-migrate``` - заодно сбрасывает кэш приложения
- пересобрать ассеты для фронта -```make prod-yarn-build```

## Что-то пошло не так :wrench:
Очевидно нужно прочитать текст ошибки, Но наиболее часто проблемы возникают в следующих случаях:
### Локально
- в Docker-контейнере (в каком-то из) не установлены нужные пакеты, зависимости, не та версия PHP и прочее
- не установлены пакеты композера (установлены, но не той версии)
- не установлены миграции (установлены, но не все)
- не актуальный кэш приложения (только если работать в режиме prod)

Для решения этих проблем разом в Makefile есть команда `make fix`. Она пересоберёт контейнеры, установит пакеты, накатит миграции и сбросит кэш :neutral_face:
### На сервере
- после обновления кода, на сайте всё еще старая версия
- после обновления кода, посыпались ошибки (в режиме prod, как правило, код 500), которых нет локально

Скорее всего не сброшен кэш приложения. Кэш приложения можно сбросить одной из двух команду `prod-composer-install`
или `prod-migrate`. Либо не собраны новые ассеты, команда `prod-yarn-build` их соберет. Можно сразу выполнить `prod-build`,
которая и сбросит кэш приложения, и пересоберёт ассеты ( а заодно еще всякие полезные штуки на всякий случай).

Если и после этого интерфейс сайта выглядит не обновленным, то скорее всего проблема с версионностью ассетов. Нужно
использовать (и обновлять) хэши и get-параметры при запросе файлов ассетов (css и js), а также картинок.

## Деплой на сервер с помощью CAPISTRANO
Это хорошо, но пока в ISPManager не работает.

CAPISTRANO:
1) Установка capistrano на локальную машину
gem install capistrano
2) Генерация SSH-ключа на локальной машине
ssh-keygen -t rsa
3) Добавить получившийся id_rsa.pub в свой профиль на gitlab
4) Добавить id_rsa.pub на сервер
 /home/deploy/.ssh/authorized_keys
Процесс деплоя:
1) Открыть терминал в папке проекта
2) Перейти в папку
cd dev-tools/capistrano
3) Запустить команду
cap production deploy BRANCH=main

где:
cap - команда вызова капистрано
production - конфигурация деплоя на сервер (файл dev-tools/capistrano/config/deploy/production.rb)
BRANCH=main - ветка, которую нужно выложить

4) Ждем ...
5) Готово
